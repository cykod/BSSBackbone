<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Data Set</title>
      <script src='js/jquery.min.js'></script>
      <script src='js/handlebars.js'></script>
      <script src='js/underscore.js'></script>
      <script src='js/backbone.js'></script>
</head>
<body>
<script>
$(function() {

  var albumTemplate = window.albumTemplate = Handlebars.compile($("#album-template").html());
  var searchTemplate = window.albumTemplate = Handlebars.compile($("#search-template").html());

  var Album = window.Album = Backbone.Model.extend({});
  var Search = window.Search = Backbone.Model.extend({});

  var AlbumCollection = window.AlbumCollection = Backbone.Collection.extend({
    model: Album,

    filtered: function(query) {
      if(!query) return this;
      query = query.toLowerCase();
      return _(this.filter(function(model) {
          return model.get("title").toLowerCase().indexOf(query) != -1;
      }));
    }
  });


  var AlbumCollectionView = Backbone.View.extend({
    tagName: "ul",

    initialize: function() {

      // Bind to search filter changes
      this.model.on("change",this.render,this);
    },
    render: function() {
      $(this.el).empty();
      this.collection.filtered(this.model.get("query")).each(function(album) {
        $(this.el).append(new AlbumView({model: album }).render().el);
      },this);
      return this;
    }
  });

  var AlbumView = Backbone.View.extend({
    tagName: "li",
    className: "album",
    template: albumTemplate,

    initialize: function(options) {
      _.bindAll(this,"render");
      this.model.on("change",this.render);
    },

    render: function() {
      $(this.el).empty()
                .append(this.template(this.model.toJSON()));
      return this;
    }
  });

  var SearchView = Backbone.View.extend({
    template: searchTemplate,

    events: {
      "keyup input, change input": "setSearch"
    },

    render: function() {
      $(this.el).empty()
                .append(this.template(this.model.toJSON()));
      return this;
    },

    setSearch: function() {
      this.model.set({ query: this.$("input").val() });
    }
  });

  var albums = null;
  var search = null;

  // API Docs
  // http://www.discogs.com/developers/resources/database/search-endpoint.html
  $.getJSON('discogs-data.json',function(data) {

     search = window.search = new Search();
     albums = window.albums = new AlbumCollection(data.results.slice(0,20));

     $("#container").append(new SearchView({ model: search }).render().el);
     $("#container").append(new AlbumCollectionView({ collection: albums, model: search }).render().el);
  });
});

</script> 

<script type='handlebars' id='search-template'>
<input type='search' id='search'/>
</script>

<script type='handlebars' id='album-template'>
<img src='{{thumb}}' width='64'/> 
<a href='http://www.discogs.com/{{uri}}'>{{title}}</a>
{{#if year}} / Released {{year}} {{/if}}
</script>

<div id='container'>

</div>

</script>
</body>
</html>
